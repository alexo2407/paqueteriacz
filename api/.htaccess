# API Router Configuration
# Redirige todas las peticiones a /api/ al router index.php

Options -Indexes
Options -MultiViews

# Habilitar rewrite engine
RewriteEngine On

# Pasar el header Authorization como variable de entorno para JWT
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [E=HTTP_AUTHORIZATION:%1]

# Si el proxy envía X-Forwarded-Proto=https, marcar HTTPS en env
RewriteCond %{HTTP:X-Forwarded-Proto} =https [OR]
RewriteCond %{HTTP:X-Forwarded-Ssl} =on
RewriteRule .* - [E=HTTPS:on]

# Excluir el directorio doc/ del router (es documentación estática HTML/PHP)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/doc/
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en crm/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/crm/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en usuarios/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/usuarios/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en geoinfo/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/geoinfo/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en auth/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/auth/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en monedas/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/monedas/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en pedidos/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/pedidos/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en productos/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/productos/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en mensajeria/ (sin pasar por router)
RewriteCond %{REQUEST_URI} (?:^/(?:[^/]+/)?|/)api/mensajeria/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Permitir acceso directo a archivos .php en utils/ (sin pasar por router)
RewriteCond %{REQUEST_URI} ^/(?:[^/]+/)?api/utils/.*\.php$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# No reescribir si es un archivo o directorio que existe físicamente
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Clean URLs: Si existe el archivo con .php, usarlo
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)$ $1.php [QSA,L]

# Redirigir el resto al router API (index.php)
RewriteRule ^(.*)$ index.php [QSA,L]
